<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thumbnail Insights</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="nav">
    <div class="brand">
      <span class="brand__dot"></span>
      <h1 class="brand__title">Thumbnail <strong>Insights</strong></h1>
    </div>
  </header>

  <main class="layout">
    <!-- Input -->
    <section class="panel panel--input">
      <h2>Input</h2>
      <div class="field">
        <label>By URL</label>
        <div class="input-row">
          <input id="url" type="text" placeholder="https://example.com/image.jpg" />
          <button id="btnUrl" class="btn">Analyze</button>
        </div>
      </div>
      <div class="hint">
        <span class="dot"></span>
        Using model:
        <code id="modelTag">Xenova/vit-gpt2-image-captioning</code>
      </div>
    </section>

    <!-- Imagen y caption -->
    <section class="panel panel--preview">
      <div id="urlPrev" class="preview">
        <div class="placeholder">Paste an image URL to start.</div>
      </div>
      <div id="urlResult" class="caption-box">
        <div class="placeholder">Awaiting analysis…</div>
      </div>
    </section>

    <!-- Métricas -->
    <section class="panel panel--metrics">
      <h2>Visual Metrics</h2>
      <div class="metrics">
        <div class="metric"><span>Brightness</span><strong id="mBrightness">—</strong></div>
        <div class="metric"><span>Contrast</span><strong id="mContrast">—</strong></div>
        <div class="metric"><span>Saturation</span><strong id="mSaturation">—</strong></div>
        <div class="metric"><span>Dominant Color</span><div id="mColor" class="swatch"></div></div>
        <div class="metric"><span>Edge Density</span><strong id="mEdges">—</strong></div>
        <div class="metric"><span>Text Ratio</span><strong id="mText">—</strong></div>
      </div>
    </section>
  </main>

  <script>
    const API_DEFAULT = 'https://caption-backend-production-5f4a.up.railway.app/caption';
    const backendUrl = localStorage.getItem('CAPTION_API') || API_DEFAULT;

    function setModelTag(text){ document.getElementById('modelTag').textContent = text || '—'; }
    function spinner(){ return `<div class="loader"></div><div class="muted xs">Processing…</div>`; }

    // --- FUNCIÓN DE MÉTRICAS (NUEVA) ---
    // Resetea las métricas a su estado inicial
    function resetMetrics() {
      document.getElementById('mBrightness').textContent = '—';
      document.getElementById('mContrast').textContent = '—';
      document.getElementById('mSaturation').textContent = '—';
      // Resetea el color al gradiente por defecto (definido en style.css)
      document.getElementById('mColor').style.background = '';
      document.getElementById('mEdges').textContent = '—';
      document.getElementById('mText').textContent = '—';
    }

    // --- FUNCIÓN DE RESULTADO (ACTUALIZADA) ---
    function displayResult(data){
      const box = document.getElementById('urlResult');
      if (data?.model) setModelTag(data.model);

      if (data?.error || !data?.caption){
        box.innerHTML = `<div class="error">⚠️ ${data.error || 'No response.'}</div>`;
        return;
      }
      
      // 1. Mostrar el Caption
      box.innerHTML = `<div class="caption"><h3>AI Caption</h3><p>${data.caption}</p></div>`;

      // 2. Mostrar las Métricas (si existen)
      if (data.metrics) {
        const metrics = data.metrics;
        // Helper para convertir 0.0-1.0 a "0%"-"100%"
        const toPercent = (n) => (n * 100).toFixed(0) + '%';

        document.getElementById('mBrightness').textContent = toPercent(metrics.brightness);
        document.getElementById('mContrast').textContent = toPercent(metrics.contrast);
        document.getElementById('mSaturation').textContent = toPercent(metrics.saturation);
        document.getElementById('mColor').style.background = metrics.dominantColor;
        document.getElementById('mEdges').textContent = toPercent(metrics.edgeDensity);
        document.getElementById('mText').textContent = toPercent(metrics.textRatio); // Mostrará 0%
      }
    }

    // --- FUNCIÓN PRINCIPAL (ACTUALIZADA) ---
    async function captionByUrl(){
      const url = document.getElementById('url').value.trim();
      const prev = document.getElementById('urlPrev');
      const result = document.getElementById('urlResult');
      if (!url) {
        // No usar alert, es bloqueante.
        console.warn('No URL provided');
        return;
      }

      // Limpiar métricas anteriores
      resetMetrics(); // <--- AÑADIDO

      prev.innerHTML = `<img src="${url}" alt="preview" />`;
      result.innerHTML = spinner();

      try {
        const res = await fetch(backendUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ image_url: url })
        });
        if (!res.ok) throw new Error('Server error ' + res.status);
        const data = await res.json();
        displayResult(data);
      } catch (err) {
        displayResult({ error: err.message });
      }
    }

    document.getElementById('btnUrl').addEventListener('click', captionByUrl);
  </script>
</body>
</html>